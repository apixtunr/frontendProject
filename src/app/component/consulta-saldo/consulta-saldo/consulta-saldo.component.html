<div class="container-fluid mt-4">
  <div class="row">
    
    <!-- Panel de búsqueda -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-search"></i>
            Consulta de Saldos
          </h5>
        </div>
        <div class="card-body">
          
          <!-- Selector de tipo de búsqueda -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">Tipo de Consulta</label>
              <button type="button" class="btn btn-secondary mb-3" routerLink="/menu">
                Ir al Menú <i class="bi bi-arrow-right"></i>
              </button>
            </div>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" id="tipoCliente" autocomplete="off" 
                     [checked]="tipoBusqueda === 'cliente'" (change)="cambiarTipoBusqueda('cliente')">
              <label class="btn btn-outline-primary" for="tipoCliente">
                <i class="bi bi-person"></i> Por Cliente
              </label>

              <input type="radio" class="btn-check" id="tipoCuenta" autocomplete="off"
                     [checked]="tipoBusqueda === 'cuenta'" (change)="cambiarTipoBusqueda('cuenta')">
              <label class="btn btn-outline-primary" for="tipoCuenta">
                <i class="bi bi-credit-card"></i> Por Cuenta
              </label>

              <input type="radio" class="btn-check" id="tipoNombre" autocomplete="off"
                     [checked]="tipoBusqueda === 'nombre'" (change)="cambiarTipoBusqueda('nombre')">
              <label class="btn btn-outline-primary" for="tipoNombre">
                <i class="bi bi-person-search"></i> Por Nombre
              </label>
            </div>
          </div>

          <!-- Formulario por ID Cliente -->
          <div *ngIf="tipoBusqueda === 'cliente'" class="mb-3">
            <label class="form-label">
              <i class="bi bi-hash"></i>
              ID del Cliente
            </label>
            <input 
              type="number" 
              class="form-control" 
              [(ngModel)]="consultaRequest.idCliente"
              placeholder="Ingrese el ID del cliente"
              min="1"
              [disabled]="buscando || cargandoCatalogos">
          </div>

          <!-- Formulario por ID Cuenta -->
          <div *ngIf="tipoBusqueda === 'cuenta'" class="mb-3">
            <label class="form-label">
              <i class="bi bi-credit-card-2-front"></i>
              Número de Cuenta
            </label>
            <input 
              type="number" 
              class="form-control" 
              [(ngModel)]="consultaRequest.idCuenta"
              placeholder="Ingrese el número de cuenta"
              min="1"
              [disabled]="buscando || cargandoCatalogos">
          </div>

          <!-- Formulario por Nombre y Apellido -->
          <div *ngIf="tipoBusqueda === 'nombre'">
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-person"></i>
                Nombre del Cliente
              </label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="consultaRequest.nombre"
                placeholder="Ingrese el nombre"
                [disabled]="buscando || cargandoCatalogos">
            </div>
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-person-fill"></i>
                Apellido del Cliente
              </label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="consultaRequest.apellido"
                placeholder="Ingrese el apellido"
                [disabled]="buscando || cargandoCatalogos">
            </div>
          </div>

          <!-- Mensaje de error -->
          <div *ngIf="error" class="alert alert-danger d-flex align-items-center mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>{{ error }}</div>
          </div>

          <!-- Botones de acción -->
          <div class="d-grid gap-2">
            <button 
              type="button" 
              class="btn btn-primary"
              (click)="consultarSaldo()"
              [disabled]="buscando || cargandoCatalogos || !validarFormulario()">
              
              <span *ngIf="buscando" class="spinner-border spinner-border-sm me-2"></span>
              <i *ngIf="!buscando" class="bi bi-search me-2"></i>
              {{ buscando ? 'Consultando...' : 'Consultar Saldo' }}
            </button>
            
            <button 
              type="button" 
              class="btn btn-outline-secondary"
              (click)="limpiarFormulario()"
              [disabled]="buscando || cargandoCatalogos">
              <i class="bi bi-arrow-clockwise me-2"></i>
              Limpiar
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Panel de resultados -->
    <div class="col-lg-8">
      
          <!-- Mensaje inicial -->
      <div *ngIf="!consultaRealizada && !cargandoCatalogos" class="card">
        <div class="card-body text-center p-5">
          <i class="bi bi-search display-1 text-muted"></i>
          <h4 class="text-muted mt-3">Consulta de Saldos</h4>
          <p class="text-muted">Seleccione un tipo de búsqueda e ingrese los datos para consultar los saldos.</p>
        </div>
      </div>

      <!-- Cargando catálogos -->
      <div *ngIf="cargandoCatalogos" class="card">
        <div class="card-body text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <h4 class="text-muted mt-3">Inicializando</h4>
          <p class="text-muted">Cargando catálogos de tipos y estados...</p>
        </div>
      </div>      <!-- Resultado: Por Cliente -->
      <div *ngIf="consultaRealizada && resultadoCliente && tipoBusqueda === 'cliente'" class="card">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="bi bi-person-check"></i>
            Cuentas y Saldos encontrados
          </h6>
        </div>
        <div class="card-body">
          
          <!-- Información del cliente -->
          <div class="row mb-4">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">ID Cliente:</dt>
                <dd class="col-sm-8">{{ resultadoCliente.persona.idPersona }}</dd>
                <dt class="col-sm-4">Nombre:</dt>
                <dd class="col-sm-8">{{ resultadoCliente.persona.nombreCompleto }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-6">Total Cuentas:</dt>
                <dd class="col-sm-6">{{ resultadoCliente.cuentas.length }}</dd>
                <dt class="col-sm-6">Saldo Total:</dt>
                <dd class="col-sm-6" [ngClass]="obtenerClaseSaldo(calcularTotalSaldos(resultadoCliente.cuentas))">
                  <strong>Q {{ calcularTotalSaldos(resultadoCliente.cuentas) | number:'1.2-2' }}</strong>
                </dd>
              </dl>
            </div>
          </div>

          <!-- Tabla de cuentas -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Cuenta</th>
                  <th>Tipo</th>
                  <th>Saldo Anterior</th>
                  <th>Débitos</th>
                  <th>Créditos</th>
                  <th>Saldo Actual</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cuenta of resultadoCliente.cuentas">
                  <td><strong>{{ cuenta.idCuenta }}</strong></td>
                  <td>
                    <span class="badge bg-info text-dark">{{ cuenta.nombreTipoSaldo }}</span>
                  </td>
                  <td>Q {{ cuenta.saldoInicial | number:'1.2-2'}}</td>
                  <td class="text-success">Q {{ cuenta.debitos | number:'1.2-2' }}</td>
                  <td class="text-danger">Q {{ cuenta.creditos | number:'1.2-2' }}</td>
                  <td [ngClass]="obtenerClaseSaldo(cuenta.saldoFinal)">
                    <strong>Q {{ cuenta.saldoFinal | number:'1.2-2'}}</strong>
                  </td>
                  <td>
                    <span class="badge bg-success">{{ cuenta.estado }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Resultado: Por Cuenta -->
      <div *ngIf="consultaRealizada && resultadoCuenta && tipoBusqueda === 'cuenta'" class="card">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <i class="bi bi-credit-card-2-front"></i>
            Detalle de Cuenta #{{ resultadoCuenta.idCuenta }}
          </h6>
        </div>
        <div class="card-body">
          
          <div class="row">
            <!-- Información de la cuenta -->
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Número de Cuenta:</dt>
                <dd class="col-sm-7"><strong>{{ resultadoCuenta.idCuenta }}</strong></dd>
                
                <dt class="col-sm-5">Cliente:</dt>
                <dd class="col-sm-7">{{ resultadoCuenta.nombreCompleto }}</dd>
                
                <dt class="col-sm-5">Tipo de Cuenta:</dt>
                <dd class="col-sm-7">
                  <span class="badge bg-info text-dark">{{ resultadoCuenta.nombreTipoSaldo }}</span>
                </dd>
                
                <dt class="col-sm-5">Estado:</dt>
                <dd class="col-sm-7">
                  <span class="badge bg-success">{{ resultadoCuenta.estado }}</span>
                </dd>
              </dl>
            </div>
            
            <!-- Movimientos y saldos -->
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Saldo Anterior:</dt>
                <dd class="col-sm-7">Q {{ resultadoCuenta.saldoInicial | number:'1.2-2' }}</dd>
                
                <dt class="col-sm-5">Débitos (Cargos):</dt>
                <dd class="col-sm-7 text-success">
                  <strong>+ Q {{ resultadoCuenta.debitos | number:'1.2-2' }}</strong>
                </dd>
                
                <dt class="col-sm-5">Créditos (Abonos):</dt>
                <dd class="col-sm-7 text-danger">
                  <strong>- Q {{ resultadoCuenta.creditos | number:'1.2-2' }}</strong>
                </dd>
                
                <dt class="col-sm-5">Saldo Actual:</dt>
                <dd class="col-sm-7" [ngClass]="obtenerClaseSaldo(resultadoCuenta.saldoFinal)">
                  <h5 class="mb-0">Q {{ resultadoCuenta.saldoFinal | number:'1.2-2' }}</h5>
                </dd>
              </dl>
            </div>
          </div>

          <!-- Fórmula de cálculo -->
          <hr>
          <div class="card bg-light">
            <div class="card-body p-3">
              <h6 class="card-title">Cálculo del Saldo</h6>
              <p class="card-text">
                <strong>Fórmula:</strong> SaldoActual = SaldoAnterior + Débitos - Créditos<br>
                <strong>Cálculo:</strong> Q {{ resultadoCuenta.saldoInicial | number:'1.2-2'  }} + 
                Q {{ resultadoCuenta.debitos | number:'1.2-2' }} - 
                Q {{ resultadoCuenta.creditos | number:'1.2-2'  }} = 
                <span [ngClass]="obtenerClaseSaldo(resultadoCuenta.saldoFinal)">
                  <strong>Q {{ resultadoCuenta.saldoFinal | number:'1.2-2'  }}</strong>
                </span>
              </p>
            </div>
          </div>
          
        </div>
      </div>

      <!-- Resultado: Por Nombre -->
      <div *ngIf="consultaRealizada && resultadosNombre.length > 0 && tipoBusqueda === 'nombre'" class="card">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0">
            <i class="bi bi-people"></i>
            Resultados de la búsqueda ({{ resultadosNombre.length }} cliente{{ resultadosNombre.length > 1 ? 's' : '' }})
          </h6>
        </div>
        <div class="card-body">
          
          <div class="row" *ngFor="let resultado of resultadosNombre; let i = index">
            <div class="col-12 mb-4">
              <div class="card border-secondary">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="bi bi-person-fill"></i>
                    {{ resultado.persona.nombreCompleto }} (ID: {{ resultado.persona.idPersona }})
                  </h6>
                </div>
                <div class="card-body">
                  
                  <!-- Resumen del cliente -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <span class="badge bg-info">{{ resultado.cuentas.length }} cuenta{{ resultado.cuentas.length > 1 ? 's' : '' }}</span>
                    </div>
                   <div class="col-md-6 text-end">
                      <span class="badge bg-success">
                        Saldo Total: Q {{ calcularTotalSaldos(resultado.cuentas) | number:'1.2-2' }}
                      </span>
                    </div>
                  </div>

                  <!-- Mini tabla de cuentas -->
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Cuenta</th>
                          <th>Tipo</th>
                          <th>Saldo Actual</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let cuenta of resultado.cuentas">
                          <td>{{ cuenta.idCuenta }}</td>
                          <td>{{ cuenta.nombreTipoSaldo }}</td>
                          <td [ngClass]="obtenerClaseSaldo(cuenta.saldoFinal)">
                            Q {{ cuenta.saldoFinal | number:'1.2-2' }}
                          </td>
                          <td>
                            <span class="badge bg-success">{{ cuenta.estado }}</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sin resultados -->
      <div *ngIf="consultaRealizada && !resultadoCliente && !resultadoCuenta && resultadosNombre.length === 0" class="card">
        <div class="card-body text-center p-5">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h4 class="text-muted mt-3">Sin resultados</h4>
          <p class="text-muted">No se encontraron cuentas o saldos con los criterios de búsqueda proporcionados.</p>
        </div>
      </div>

    </div>
  </div>
</div>
